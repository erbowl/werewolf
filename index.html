<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>人狼web</title>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src='https://cdn.webrtc.ecl.ntt.com/skyway-latest.js' type='text/javascript'></script>
    <script crossorigin='anonymous' integrity='sha256-DI6NdAhhFRnO2k51mumYeDShet3I8AKCQf/tf7ARNhI=' src='https://code.jquery.com/ui/1.11.4/jquery-ui.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js'></script>
    <script src="https://cdn.jsdelivr.net/clipboard.js/1.5.3/clipboard.min.js"></script>


<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <style media="screen">
        video.other-peer{
            object-fit: cover;
            border: 4px solid black;
            width: 200px;
            height: 200px;
            border-radius: 300px;
            text-align: center;
            display: none;
        }
        video.other-peer:hover{
          cursor: move;
        }
       #my-video_div{
         position: fixed;
         left:0px;
         bottom:0px;
         width: 200px;
       }
       #my-video{
         left:0px;
         height: 200px;
         width: 200px;
       }
       #alert{
         text-align: center;
       }
       .人狼,.占い師{
         display: none;
       }
    </style>
  </head>




  <body>
    <div class="alert alert-info" role="alert" id="alert">現在、準備中です</div>
    <div class="progress">
      <div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width: 40%">
        <span class="sr-only">40% Complete (success)</span>
      </div>
    </div>
    <input id="room_id" class="owner"readonly></input>
    <!-- コピーボタン -->
    <button id="clip" class="btn owner" data-clipboard-target="#room_id">
       クリックしてコピー
    </button>
    <p/>現在：昼<p>
    <p>夜まで3:00</p>
    <p>接続人数:<span id="p_c">1</span>人</p>

    <button class="owner btn btn-info"type="button" name="button" id="start">ゲームスタート</button>
    <input id="select" class="人狼 占い師"readonly>
    <button class="人狼 btn btn-info"type="button" name="button">人狼</button>
    <button class="占い師 btn btn-info"type="button" name="button">占い師</button>
    <div id='my-video_div'>
      <p id="post_p">あなたの役職：<span id="post">未決定</span></p>
      <video  id='my-video' autoplay muted></video>
    </div>






    <script type="text/javascript">

    // clipboard
    $(function () {
        var clipboard = new Clipboard('#clip');
        clipboard.on('success', function(e) {
          e.clearSelection();
        });
     });



    /* eslint-disable require-jsdoc */
    $(function() {
      var owner=true;
      if (location.hash) {
        var roomName=location.hash.replace( /#/g , "" );
        $('.owner').hide();
      }else{
        var roomName=new Date().getTime();
        $("#room_id").val(location.href+"#"+roomName);

      }


      var peer_count=1;
      const peer = new Peer({
        key:   "8cca2734-94ae-44fd-af8e-84a73633d9a4",
        debug: 3
      });
      let localStream;
      let room;
      var posts;
      var my_post;
      peer.on('open',function(){
        navigator.mediaDevices.getUserMedia({video:{width:100,height:100}, audio:true }).then(stream => {
          $('#my-video').get(0).srcObject = stream;
          localStream = stream;
          room=peer.joinRoom(roomName,{mode:"sfu",stream:localStream});
          room.on('open',function(){
            //  スタートボタン
            $("#start").click(function(){
              $(this).hide();
              var members=room.members;
              // 役職決定
              posts=set_posts(peer_count);
              // 自分は先頭
              my_post=posts[0];
              $("#post").text(my_post);
              // みんなに送る
              for (var i = 0; i < peer_count-1; i++) {
                room.send({label:members[i],data:posts[i+1]});
              }

              chagen_and_send_alert(room,"ゲームが開始されました。今回の役職を確認してください");
              Night(room,my_post);
            })

            room.on("stream",function(stream){
              stream_to_tag(stream);
            })
            room.on("data",function(data){
              if (data.data.label=="peer_count") {
                peer_count=data.data.data;
                $("#p_c").text(peer_count);
              }else if(data.data.label=="alert"){
                $("#alert").text(data.data.data);
              }else if(data.data.label==peer.id){
                my_post=data.data.data;
                $("#post").text(my_post);
                Night(room,my_post);
              }
            })

            $("#my-video").click(function(){
              var condition={width:100,height:100};
              // 一回全部止める
              localStream.getAudioTracks()[0].stop();
              if(localStream.getVideoTracks()[0]){
                localStream.getVideoTracks()[0].stop();
                condition=false;
              }
              navigator.mediaDevices.getUserMedia({video:condition, audio:true }).then(stream => {
                localStream=stream;
                room.replaceStream(localStream);
                $('#my-video').get(0).srcObject = localStream;
              })
            })

            room.on("peerLeave",function(peerId){
              peer_count--;
              $("#p_c").text(peer_count);

              $("video#"+peerId).hide();
            })
            room.on("peerJoin",function(peerId){
              peer_count++;
              $("#p_c").text(peer_count);
              room.send({label:"peer_count",data:peer_count});
            })
          })
        })
      })

    function chagen_and_send_alert(room,text) {
      $("#alert").text(text);
      room.send({label:"alert",data:text});
    }


    function stream_to_tag(stream) {
      if($("video#"+stream.peerId).length==0){
        $video=$("<video>");
        $("body").append($video);
        $video.attr("src",window.URL.createObjectURL(stream));
        $video.attr("id",stream.peerId);
        $video.attr("class","other-peer");
        $video.attr("autoplay",true);
        $video.attr("poster","");
        $video.show();
        var rgbColor = 'rgb(' + Math.floor(Math.random() * 256) + ',' + Math.floor(Math.random() * 256) + ',' + Math.floor(Math.random() * 256) + ')';
        $video.css('border-color', rgbColor);
        $video.draggable();
        $pe=$("<p>"+stream.peerId+"</p>");
        $("#peers").append($pe);
        $pe.css('color', rgbColor);;
      }else{
        // すでにDOMがあるときはstreamを入れ替える
        $("video#"+stream.peerId).attr("src",window.URL.createObjectURL(stream));
      }
    }

    function Night(room,post) {
      $("."+post).show();
      $(document).on('click','video.other-peer',function(){
        $("#select").val($(this).attr("id"));
      });
    }
    function Day(room) {

    }

    function set_posts(int) {
      var res=["占い師","人狼"];
      if (int>5) {
        res.push(["人狼","狂人"]);
        int-=2;
      }
      int-=2;
      for (var i = 0; i < int; i++) {
        res.push("村人");
      }
      for(var i = res.length - 1; i > 0; i--){
        var r = Math.floor(Math.random() * (i + 1));
        var tmp = res[i];
        res[i] = res[r];
        res[r] = tmp;
      }
      return res;
    }
    var m;
    var s;
    var remaining;



    function countDown(){
      m=parseInt($("#timer_m").text());
      s=parseInt($("#timer_s").text());
      remaining=m*60+s;
      if(remaining>0){
         if (s>0) {
           s--;
         }else{
           s=59;
           m--;
         }
         $("#timer_m").text(('00' + m).slice(-2));
         $("#timer_s").text(('00' + s).slice(-2));
      }else{
        $("a#tri").click();
        clearTimeout(set);
      }
    }
    var set=setInterval(countDown,1000);
    });

    </script>
  </body>
</html>
