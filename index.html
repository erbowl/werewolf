<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>人狼web</title>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src='https://cdn.webrtc.ecl.ntt.com/skyway-latest.js' type='text/javascript'></script>
    <script crossorigin='anonymous' integrity='sha256-DI6NdAhhFRnO2k51mumYeDShet3I8AKCQf/tf7ARNhI=' src='https://code.jquery.com/ui/1.11.4/jquery-ui.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-color/2.1.2/jquery.color.js"></script>


<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <style media="screen">
        video.other-peer{
            object-fit: cover;
            border: 4px solid black;
            width: 200px;
            height: 200px;
            border-radius: 300px;
            text-align: center;
            display: none;
        }
        video.other-peer:hover{
          cursor: move;
        }
       #my-video_div{
         position: fixed;
         left:0px;
         bottom:0px;
         width: 200px;
       }
       .my-video{
         left:0px;
         height: 200px;
         width: 200px;
       }
       #alert{
         text-align: center;
       }
       #peers{
         position: absolute;
         right:0px;
         bottom:0px;
         height: 200px;
         width: 300px;
       }
       #select,#select_day{
         width: 300px
       }
       .人狼,.占い師,.騎士,.day,#dead{
         display: none;
       }
       .dead{
         opacity: 0.2;
       }
    </style>
  </head>




  <body>
    <br>
    <div class="alert alert-info" role="alert" id="alert">現在、準備中です</div>
    <div class="start">
      部屋の名前：<input value="" pattern="^[0-9A-Za-z]+$"id="room_id"><br>
      自分の名前：<input pattern="^[A-Za-z]+$"id="nickname"><br>
      <input type="submit" class="btn btn-info"name=""id="room_select" value="決定">
      <!-- <button class="btn btn-info"type="submit" name="button" id="room_select">決定</button> -->
    </div>
    <div class="info">
      <p/>現在：<span id="day_night">昼</span><p>
      <p>接続人数:<span id="p_c">1</span>人</p>
    </div>
    <button class="disabled owner btn btn-info"type="button" name="button" id="start">ゲームスタート</button>
    <div id="day_and_night">
      <div class="night">
        <select id="select" class="人狼 占い師 騎士 form-control" >
        </select>
        <button class="人狼 btn btn-info"type="button" name="button">を食べる</button>
        <button class="占い師 btn btn-info"type="button" name="button">を占う</button>
        <button class="騎士 btn btn-info"type="button" name="button">を守る</button>
      </div>
      <div class="day">
        <select id="select_day" class="form-control" >
        </select>
        <button id="kill_peer"class="btn btn-info"type="button" name="button">を殺すに一票</button>
      </div>
    </div>
    <div id="dead">
      <p>死亡</p>
    </div>


    <div id='my-video_div'>
      <p>現在の部屋：<span id="room">未決定</span></p>
      <p>あなたの名前：<span id="name">未決定</span></p>
      <p>あなたの役職：<span id="post">未決定</span></p>
      <video  class='my-video' autoplay muted></video>
    </div>

    <div id="peers">
      <p>参加者一覧</p>
    </div>






    <script type="text/javascript">

    $(function() {

      $("#room_select").click(function(){


        if ($("#room_id").val()=="" || $("#nickname").val()=="") {
          alert("入力してください");
          return 0;
        }else if (!/^[a-zA-Z][a-zA-Z0-9]+$/.test($("#nickname").val())) {
          alert("ニックネームには半角英字のみ使用可能です");
          return 0;
        }

        $(".start").hide();
        $("#room").text($("#room_id").val());
        $("#name").text($("#nickname").val());


        var roomName=$("#room_id").val();
        const peer = new Peer($("#nickname").val(),{
          key:   "8cca2734-94ae-44fd-af8e-84a73633d9a4",
          debug: 3
        });
        let localStream;
        let room;
        var posts;
        var members=[];
        peer.isDay=true;
        peer.night_end_count=[];
        peer.day_end_count=[];


        peer.on('open',function(){
          navigator.mediaDevices.getUserMedia({video:{width:100,height:100}, audio:true }).then(stream => {
            $('.my-video').get(0).srcObject = stream;
            // $('.my-video').attr("id",peer.id);
            localStream = stream;
            room=peer.joinRoom(roomName,{mode:"sfu",stream:localStream});
            room.game={};
            room.on('open',function(){
              //  スタートボタン
              $("#start").click(function(){
                $(this).hide();
                // 役職決定
                posts=set_posts(members.length+1);
                // 自分は先頭
                peer.post=posts[0];
                $("#post").text(peer.post);
                room.game.peers={[peer.id]:{"post":peer.post}};
                for (var i = 0; i < members.length; i++) {
                  room.game.peers[members[i]]={"post":posts[i+1]};
                }
                // room.send({label:"peers",data:room.game.peers});
                room.game.day=0;
                // room.send({label:"day",data:room.game.day});
                change_and_send_alert(room,"ゲームが開始されました。今回の役職を確認してください");
                room.send({label:"startNight",data:room.game});
                Night(room,peer);
              })

              room.on("stream",function(stream){
                members.push(stream.peerId);
                $("#p_c").text(members.length+1);
                if (members.length>2) {
                  $("#start").removeClass("disabled");
                }
                stream_to_tag(stream);
              })
              room.on("data",function(data){
                if(data.data.label=="alert"){
                  $("#alert").text(data.data.data);
                }else if(data.data.label=="night_end_count"){
                  if (peer.night_end_count.indexOf(data.data.data)==-1) {
                    peer.night_end_count.push(data.data.data);
                  }
                  if (room.game.peers[data.src].post=="人狼" && peer.post=="人狼") {
                    $(".人狼").hide();
                  }

                  if (peer.night_end_count.length==Object.keys(room.game.peers).length && peer.end) {
                    room.game.day++;
                    // ↓はちょっと頑張ればいらない
                    room.send({label:"day",data:room.game.day});

                    room.send({label:"startDay",data:room.game});
                    Day(room,peer);
                    peer.night_end_count=[];
                  }
                }else if(data.data.label=="day_end_count"){
                  peer.day_end_count.push(data.data.data);
                  if (peer.day_end_count.length==Object.keys(room.game.peers).length && peer.end) {
                    var max=0;
                    var dead_key="";
                    Object.keys(room.game.kill_peer).forEach(function (key) {
                      if (room.game.kill_peer[key]>=max) {
                        max=room.game.kill_peer[key];
                        dead_key=key;
                      }
                    });
                    room.game["dead"]=dead_key;
                    room.send({label:"startNight",data:room.game});

                    peer.night_end_count=[];

                    Night(room,peer);
                    peer.isDay=false;

                    peer.day_end_count=[];
                  }
                }else if(data.data.label=="kill_peer"){
                  room.game.kill_peer[data.data.data]++;
                }else if(data.data.label=="startDay" && !peer.isDay){
                  peer.isDay=true;
                  room.game=data.data.data;
                  Day(room,peer);
                  peer.night_end_count=[];
                }else if(data.data.label=="startNight" && peer.isDay){
                  peer.isDay=false;
                  room.game=data.data.data;
                  if (room.game.day==0) {
                    $("#start").hide();
                    peer.post=room.game.peers[peer.id].post;
                    $("#post").text(peer.post);
                  }
                  peer.night_end_count=[];
                  Night(room,peer);
                  peer.day_end_count=[];
                }

                if (/^add_.*$/.test(data.data.label)) {
                  var key=data.data.label.replace( /add_/g , "");
                  room.game[key]=data.data.data;
                }
              })

              $(".my-video").click(function(){
                var condition={width:100,height:100};
                // 一回全部止める
                localStream.getAudioTracks()[0].stop();
                if(localStream.getVideoTracks()[0]){
                  localStream.getVideoTracks()[0].stop();
                  condition=false;
                }
                navigator.mediaDevices.getUserMedia({video:condition, audio:true }).then(stream => {
                  localStream=stream;
                  room.replaceStream(localStream);
                  $('.my-video').get(0).srcObject = localStream;
                })
              })

              room.on("peerLeave",function(peerId){
                members.splice(members.indexOf(peerId),1);
                $("#p_c").text(members.length+1);
                $("p#"+peerId).remove();
                $("video#"+peerId).remove();
              })
              room.on("peerJoin",function(peerId){
              })
            })
          })
        })
      })






    function change_and_send_alert(room,text) {
      $("#alert").text(text);
      room.send({label:"alert",data:text});
    }

    function stream_to_tag(stream) {
      if($("video#"+stream.peerId).length==0){
        $video=$("<video>");
        $("body").append($video);
        $video.attr("src",window.URL.createObjectURL(stream));
        $video.attr("id",stream.peerId);
        $video.attr("class","other-peer");
        $video.attr("autoplay",true);
        $video.attr("poster","");
        $video.show();
        var rgbColor = 'rgb(' + Math.floor(Math.random() * 256) + ',' + Math.floor(Math.random() * 256) + ',' + Math.floor(Math.random() * 256) + ')';
        $video.css('border-color', rgbColor);
        $video.draggable();
        $pe=$("<p>"+stream.peerId+"</p>");
        $pe.attr("id",stream.peerId);
        $("#peers").append($pe);
        $pe.css('color', rgbColor);;
      }else{
        // すでにDOMがあるときはstreamを入れ替える
        $("video#"+stream.peerId).attr("src",window.URL.createObjectURL(stream));
      }
    }

    function set_select_box(peers,selecter) {
      $(selecter).empty();
      Object.keys(peers).forEach(function (key) {
        $(selecter).append("<option value='"+key+"'>"+key+"</option>");
      });
    }

    function getDeadPeer(room) {
      if (room.game.dead && !room.game.guard) {
        return room.game.dead;
      }else{
        return false;
      }
    }

    function ViewChange(str) {
      var b_color;
      var color;
      if (str=="夜") {
        var b_color="black";
        var color="white";
        $(".night").show();
        $(".day").hide();
      }else{
        var b_color="white";
        var color="black";
        $(".day").show();
        $(".night").hide();
      }
      $("body").animate(
        {'color': color,
          'backgroundColor': b_color
        }, 1500
      );
      $("#day_night").text(str);
    }

    function Night(room,peer) {
      ViewChange("夜");
      if (peer.dead) {
        peer.end=true;
        return 0;
      }
      $("#alert").text("夜になりました。");
      peer.end=false;

      room.game.kill_peer=undefined;

      var dead_peer=getDeadPeer(room);
      if (dead_peer){
        delete room.game.peers[dead_peer];
        // room.send({label:"peers",data:room.game.peers});
        if (dead_peer==peer.id) {
          $("#alert").text("多数決の結果、あなたは殺されました");
          dead_mode();
          peer.dead=true;
          peer.end=true;
          return 0;
        }else{
          $("#alert").text(dead_peer+"が多数決で殺されました");
          $("video#"+dead_peer).addClass("dead");
          $("video#"+dead_peer).attr("muted","");
        }
      }

      set_select_box(room.game.peers,"#select");
      // 選択肢から自分を除く
      $("#select > [value="+peer.id+"]").remove();

      Object.keys(room.game.peers).forEach(function (key) {
        // 自分と相手が人狼同士以外は隠す
        if (!(peer.post=="人狼" && room.game.peers[key].post=="人狼")) {
          $("video#"+key).hide();
          $("video#"+key).attr("muted","");
        }
      });


      if (room.game.day>0 || peer.post=="占い師") {
        if (["占い師","人狼","騎士"].indexOf(peer.post) >= 0) {
          $("."+peer.post).show();
          $("button.占い師").click(function(){
            $(".night").hide();
            alert(room.game.peers[$("#select").val()].post);
            room.send({label:"night_end_count",data:peer.id});
            peer.night_end_count.push(peer.id);
            peer.end=true;
          })
          $("button.人狼").click(function(){
            $(".night").hide();
            room.game["dead"]=$("#select").val();
            room.send({label:"add_dead",data:room.game["dead"]});
            room.send({label:"night_end_count",data:peer.id});
            peer.night_end_count.push(peer.id);
            peer.end=true;
          })
          $("button.騎士").click(function(){
            $(".night").hide();
            room.game["guard"]=$("#select").val();
            room.send({label:"add_guard",data:room.game["guard"]});
            room.send({label:"night_end_count",data:peer.id});
            peer.night_end_count.push(peer.id);
            peer.end=true;
          })
        }else{
          peer.end=true;
          peer.night_end_count.push(peer.id);
          setTimeout(function () {room.send({label:"night_end_count",data:peer.id})}, 10*1000);
        }
      }else{
        peer.end=true;
        peer.night_end_count.push(peer.id);
        setTimeout(function () {room.send({label:"night_end_count",data:peer.id})}, 10*1000);
      }


    }
    function dead_mode() {
      $("#day_and_night").remove();
      $("#dead").show();
      $("video").show();
    }

    function Day(room,peer) {
      ViewChange("昼");
      peer.end=false;

      var dead_peer=getDeadPeer(room);
      if (dead_peer) {
        delete room.game.peers[dead_peer];
        if (dead_peer==peer.id) {
          $("#alert").text("あなたは人狼に殺されました");
          dead_mode();
          peer.dead=true;
        }else{
          $("#alert").text(dead_peer+"は人狼に殺されました");
          $("video#"+dead_peer).addClass("dead");
          $("video#"+dead_peer).attr("muted","");
        }
      }else{
        $("#alert").text("昨晩の死者はいませんでした。殺すものを決めましょう。");
      }

      if (end_judge(room.game.peers)) {
        $("#alert").text(end_judge(room.game.peers));
        $("#day_and_night").remove();
        $("video").show();
        $("video").attr("muted",false);
        return 0;
      }

      if (peer.dead) {
        peer.end=true;
        return 0;
      }


      if (room.game.kill_peer==undefined) {
        room.game.kill_peer={};
        Object.keys(room.game.peers).forEach(function (key) {
          room.game.kill_peer[key]=0;
        });
      }
      Object.keys(room.game.peers).forEach(function (key) {
        $("video#"+key).show();
        $("video#"+key).attr("muted","false");
      });

      set_select_box(room.game.peers,"#select_day");
      $("#select_day > [value="+peer.id+"]").remove();

      $("#kill_peer").click(function(){
        $(".day").hide();
        room.game.kill_peer[$("#select_day").val()]++;
        room.send({label:"kill_peer",data:$("#select_day").val()});
        peer.day_end_count.push(peer.id);
        room.send({label:"day_end_count",data:peer.id});
        peer.end=true;
      })
    }

    function end_judge(peers) {
      var wolf=0;
      var other=0;
      Object.keys(peers).forEach(function (key) {
        if (peers[key].post=="人狼") {
          wolf++;
        }else{
          other++;
        }
      });
      if (wolf>=other) {
        return "人狼側の勝利です。";
      }else if (wolf==0) {
        return "人間側の勝利です。"
      }else{
        return false;
      }
    }

    function set_posts(int) {
      var res=["占い師","人狼","騎士"];
      int-=3;
      if (int>=4) {
        res.push(["人狼","狂人"]);
        int-=2;
      }
      for (var i = 0; i < int; i++) {
        res.push("村人");
      }
      for(var i = res.length - 1; i > 0; i--){
        var r = Math.floor(Math.random() * (i + 1));
        var tmp = res[i];
        res[i] = res[r];
        res[r] = tmp;
      }
      return res;
    }

    });

    </script>

  </body>
</html>
